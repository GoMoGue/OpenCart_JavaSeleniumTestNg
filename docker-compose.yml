# Docker Compose file for Selenium Grid with Chrome, Firefox, and Edge nodes.
# This setup allows parallel browser testing using a hub and multiple nodes.

version: "3"
services:
  # Selenium Grid hub: coordinates test sessions across nodes.
  selenium-hub:
    image: selenium/hub:latest
    container_name: selenium-hub
    ports:
      - "4442:4442" # Map port 4442 on the host to port 4442 in the container (used for the event bus).
      - "4443:4443" # Maps port 4443 on the host to port 4443 in the container (used for the event bus).
      - "4444:4444" # Maps port 4444 on the host to port 4444 in the container (used for the Grid UI and API).
    environment:
      - GRID_MAX_SESSION=6  # Maximum concurrent test sessions
      - GRID_BROWSER_TIMEOUT=3000  # Timeout for browser operations (milliseconds)
      - GRID_TIMEOUT=3000  # General grid operation timeout (milliseconds)
    networks:
      - selenium-grid-network  # Attach to the custom network for internal communication

    Chrome:
      # Chrome node: runs tests in Chrome browser.
      image: selenium/node-chrome:latest
      container_name: chrome-node
      depends_on:
        - selenium-hub  # Ensures the hub is running before the node starts
      environment:
        - SE_EVENT_BUS_HOST=selenium-hub  # Connects to the hub for event bus communication
        - SE_EVENT_BUS_PUBLISH_PORT=4442  # Port for publishing events to the hub
        - SE_EVENT_BUS_SUBSCRIBE_PORT=4443  # Port for subscribing to events from the hub
        - SE_NODE_MAX_SESSIONS=2  # Maximum concurrent sessions for this node
        - SE_NODE_OVERRIDE_MAX_SESSIONS=true  # Allows overriding default session limits
      volumes:
        - /dev/shm:/dev/shm  # Shared memory volume for Chrome performance
      shm_size: 2gb  # Increases shared memory size to prevent crashes
      networks:
        - selenium-grid-network  # Attach to the custom network

    firefox:
      # Firefox node: runs tests in Firefox browser.
      image: selenium/node-firefox:latest
      container_name: firefox-node
      depends_on:
        - selenium-hub  # Ensures the hub is running before the node starts
      environment:
        - SE_EVENT_BUS_HOST=selenium-hub  # Connects to the hub for event bus communication
        - SE_EVENT_BUS_PUBLISH_PORT=4442  # Port for publishing events to the hub
        - SE_EVENT_BUS_SUBSCRIBE_PORT=4443  # Port for subscribing to events from the hub
        - SE_NODE_MAX_SESSIONS=2  # Maximum concurrent sessions for this node
        - SE_NODE_OVERRIDE_MAX_SESSIONS=true  # Allows overriding default session limits
      volumes:
        - /dev/shm:/dev/shm  # Shared memory volume for Firefox performance
      shm_size: 2gb  # Increases shared memory size to prevent crashes
      networks:
        - selenium-grid-network  # Attach to the custom network

    edge:
      # Edge node: runs tests in Microsoft Edge browser.
      image: selenium/node-edge:latest
      container_name: edge-node
      depends_on:
        - selenium-hub  # Ensures the hub is running before the node starts
      environment:
        - SE_EVENT_BUS_HOST=selenium-hub  # Connects to the hub for event bus communication
        - SE_EVENT_BUS_PUBLISH_PORT=4442  # Port for publishing events to the hub
        - SE_EVENT_BUS_SUBSCRIBE_PORT=4443  # Port for subscribing to events from the hub
        - SE_NODE_MAX_SESSIONS=2  # Maximum concurrent sessions for this node
        - SE_NODE_OVERRIDE_MAX_SESSIONS=true  # Allows overriding default session limits
      volumes:
        - /dev/shm:/dev/shm  # Shared memory volume for Edge performance
      shm_size: 2gb  # Increases shared memory size to prevent crashes
      networks:
        - selenium-grid-network  # Attach to the custom network

  # Custom network for internal communication between hub and nodes.
  networks:
    selenium-grid-network:
      driver: bridge  # Uses Docker's default bridge driver